<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <style>
    body { margin: 0; font-family: __FONT__; font-size: 14pt; background: __HEX__; color: __FG__; transition: background 120ms ease, color 120ms ease; }
    .wrap { padding: 16px; display: flex; flex-direction: column; gap: 16px; }
    .display { text-align: center; }
    .display .hex { font-size: 18pt; font-weight: 700; }
    .display .rgb { font-size: 14pt; opacity: 0.9; }
    canvas { border-radius: 6px; border: 1px solid #30363d; cursor: crosshair; }
    #sv { width: 100%; height: 100px; display: block; }
    #hue { width: 100%; height: 16px; margin-top: 6px; display: block; }
    .row { display: flex; flex-direction: column; gap: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="display">
      <div id="hex" class="hex">#FFFFFF</div>
      <div id="rgb" class="rgb">rgb(255, 255, 255)</div>
    </div>
    <div class="row">
      <canvas id="sv"></canvas>
      <canvas id="hue"></canvas>
    </div>
  </div>
  <script>
    const sv = document.getElementById('sv');
    const hue = document.getElementById('hue');
    const hexEl = document.getElementById('hex');
    const rgbEl = document.getElementById('rgb');
    const swatch = document.getElementById('swatch');

    const svCtx = sv.getContext('2d');
    const hueCtx = hue.getContext('2d');

    const initialHex = "__HEX__";
    function hexToHsv(hex) {
      let v = hex.replace('#','');
      if (v.length === 3) v = v[0]+v[0]+v[1]+v[1]+v[2]+v[2];
      if (v.length !== 6) return {h: 0, s: 0, v: 1};
      const r = parseInt(v.slice(0,2),16)/255;
      const g = parseInt(v.slice(2,4),16)/255;
      const b = parseInt(v.slice(4,6),16)/255;
      const max = Math.max(r,g,b), min = Math.min(r,g,b);
      const d = max - min;
      let h = 0;
      if (d !== 0) {
        if (max === r) h = ((g - b) / d + (g < b ? 6 : 0));
        else if (max === g) h = ((b - r) / d + 2);
        else h = ((r - g) / d + 4);
        h /= 6;
      }
      const s = max === 0 ? 0 : d / max;
      return {h, s, v: max};
    }

    let h = 50 / 360, s = 1, v = 1; // defaults, replaced by initialHex below

    function clamp(v, min=0, max=1) { return Math.min(max, Math.max(min, v)); }

    function hsvToRgb(h, s, v) {
      let r, g, b;
      let i = Math.floor(h * 6);
      let f = h * 6 - i;
      let p = v * (1 - s);
      let q = v * (1 - f * s);
      let t = v * (1 - (1 - f) * s);
      switch (i % 6) {
        case 0: r = v; g = t; b = p; break;
        case 1: r = q; g = v; b = p; break;
        case 2: r = p; g = v; b = t; break;
        case 3: r = p; g = q; b = v; break;
        case 4: r = t; g = p; b = v; break;
        case 5: r = v; g = p; b = q; break;
      }
      return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
    }

    function rgbToHex(r,g,b) {
      const toHex = (x)=>x.toString(16).padStart(2,'0');
      return '#' + toHex(r) + toHex(g) + toHex(b);
    }

    function redrawSV() {
      const {width, height} = sv;
      // base hue gradient (left->right saturation)
      const hueGrad = svCtx.createLinearGradient(0, 0, width, 0);
      const [r, g, b] = hsvToRgb(h, 1, 1);
      hueGrad.addColorStop(0, '#fff');
      hueGrad.addColorStop(1, rgbToHex(r,g,b));
      svCtx.fillStyle = hueGrad;
      svCtx.fillRect(0, 0, width, height);
      // value gradient (top -> bright, bottom -> black)
      const valGrad = svCtx.createLinearGradient(0, 0, 0, height);
      valGrad.addColorStop(0, 'rgba(0,0,0,0)');
      valGrad.addColorStop(1, 'rgba(0,0,0,1)');
      svCtx.fillStyle = valGrad;
      svCtx.fillRect(0, 0, width, height);
    }

    function redrawHue() {
      const {width, height} = hue;
      const grad = hueCtx.createLinearGradient(0,0,width,0);
      grad.addColorStop(0.0, '#ff0000');
      grad.addColorStop(0.17, '#ffff00');
      grad.addColorStop(0.34, '#00ff00');
      grad.addColorStop(0.50, '#00ffff');
      grad.addColorStop(0.67, '#0000ff');
      grad.addColorStop(0.84, '#ff00ff');
      grad.addColorStop(1.0, '#ff0000');
      hueCtx.fillStyle = grad;
      hueCtx.fillRect(0,0,width,height);
    }

    function updateOutput() {
      const [r,g,b] = hsvToRgb(h, s, v);
      const hex = rgbToHex(r,g,b);
      hexEl.textContent = hex;
      rgbEl.textContent = `rgb(${r}, ${g}, ${b})`;
      const lum = (0.299*r + 0.587*g + 0.114*b)/255;
      const fg = lum > 0.6 ? '#0d1117' : '#e6edf3';
      document.body.style.background = hex;
      document.body.style.color = fg;
    }

    function pickSV(evt) {
      const rect = sv.getBoundingClientRect();
      const x = clamp((evt.clientX - rect.left) / rect.width);
      const y = clamp((evt.clientY - rect.top) / rect.height);
      s = x;
      v = 1 - y;
      updateOutput();
    }

    function pickHue(evt) {
      const rect = hue.getBoundingClientRect();
      const x = clamp((evt.clientX - rect.left) / rect.width);
      h = x;
      redrawSV();
      updateOutput();
    }

    function resize() {
      sv.width = sv.clientWidth;
      sv.height = sv.clientHeight;
      hue.width = hue.clientWidth;
      hue.height = hue.clientHeight;
      redrawHue();
      redrawSV();
      updateOutput();
    }

    sv.addEventListener('mousedown', (e)=>{ pickSV(e); sv.onmousemove = pickSV; });
    window.addEventListener('mouseup', ()=>{ sv.onmousemove = null; });
    hue.addEventListener('mousedown', (e)=>{ pickHue(e); hue.onmousemove = pickHue; });
    window.addEventListener('mouseup', ()=>{ hue.onmousemove = null; });

    window.addEventListener('resize', resize);

    // initialize from initialHex
    (function initFromHex(){
      const hsv = hexToHsv(initialHex);
      h = hsv.h; s = hsv.s; v = hsv.v;
      document.body.style.background = initialHex;
      const lum = (0.299*parseInt(initialHex.slice(1,3),16) + 0.587*parseInt(initialHex.slice(3,5),16) + 0.114*parseInt(initialHex.slice(5,7),16)) / 255;
      document.body.style.color = lum > 0.6 ? '#0d1117' : '#e6edf3';
      resize();
    })();

    window.clipxPayload = function() {
      const hex = (document.getElementById('hex')?.textContent || '').trim().toUpperCase();
      return {
        hex: hex,
        rgb: (document.getElementById('rgb')?.textContent || '').trim(),
        html: document.documentElement.outerHTML
      };
    };
  </script>
</body>
</html>